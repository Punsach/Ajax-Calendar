<!DOCTYPE HTML>
<head>
	<script type="text/javascript" src="month"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<meta charset="utf-8">
	<link href='calcss.css' rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700' rel='stylesheet' type='text/css'>
	<link href="dialog" rel="stylesheet"> <!-- Including CSS File Here-->
	<!-- Including CSS & jQuery Dialog UI Here-->
	<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/themes/ui-darkness/jquery-ui.css" rel="stylesheet">
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>

	
</head>

<body>
	<div id = "calendar-div">
		<header id = "calendar-header">
		</header>
		<table id = "calendar-table">

		</table>
	</div>
</body>

<div class="container" id ="container">
	<div class="main">
		<div id="addStuff" title="Add Event">
			<form id="addform" method="post">
				<label>Event Title:</label>
				<input id="eventTitle" name="eventTitle" type="text">
				<label>Time:</label>
				<input type="time" id="eventTime" placeholder="HH:MI">
				<input id="eventSubmit" type="submit" value="Submit">
			</form>
		</div>
	</div>
</div>

 <div class = "displayEvents" id = "displayTheEvents">
	<div class="main" id = "listTheEvents">
		<table id = "displayEvents" title = "Events">
		</table>
	</div>
</div> 

<div class = "modifyEvent" id = "modifyEvent">
	<div class = "main">
		<form id = "editForm", method = "post">
			<label>New Event Title:</label>
			<input id="newEventTitle" name="newEventTitle" type="text">
			<label>New Event Date:</label>
			<input id ="newEventDate", type = "date", name = "newEventDate">
			<label>New Time:</label>
			<input type="time" id="newEventTime" placeholder="HH:MI" name ="newEventTime">
			<input id="newEventSubmit" type="submit", value="Edit Event">
			<br>
			<input id = "deleteEvent", type ="submit", value = "Delete Event">
		</form>
	</div>
</div>

<script type="text/javascript">
 $(document).ready(function() {
$("#displayEvents").hide();
});
	document.addEventListener("DOMContentLoaded", updateCalendar, false); 
	var originalDOM = document.body.innerHTML;
	var originalDisplay = document.getElementById("displayEvents").innerHTML;
// For our purposes, we can keep the current month in a variable in the global scope
var currentMonth = new Month(2017, 2); // 
var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
var daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

function updateCalendar(){
	document.body.innerHTML = originalDOM;
	var prevButton = document.createElement("button");
	prevButton.setAttribute("id", "prev_month_btn");
	prevButton.appendChild(document.createTextNode("«"));
	document.getElementById("calendar-header").appendChild(prevButton);

	var newH2 = document.createElement("h2");
	newH2.appendChild(document.createTextNode(String(months[currentMonth.month] + " " + currentMonth.year)));
	document.getElementById("calendar-header").appendChild(newH2);

	var nextButton = document.createElement("button");
	nextButton.setAttribute("id", "next_month_btn");
	nextButton.appendChild(document.createTextNode("»"));
	document.getElementById("calendar-header").appendChild(nextButton);

	var newRow = document.createElement("tr");
	newRow.setAttribute("class", "calendar");
	newRow.setAttribute("id", "daysOfWeek");
	document.getElementById("calendar-table").appendChild(newRow);

	for(i = 0; i < daysOfWeek.length; i += 1)
	{
		var newCell = document.createElement("td");
		newCell.setAttribute("class", "calendar");
		newCell.appendChild(document.createTextNode(String(daysOfWeek[i])));
		document.getElementById("daysOfWeek").appendChild(newCell);
	}

	var newRow = document.createElement("tr");
	newRow.setAttribute("id", "row1");
	document.getElementById("calendar-table").appendChild(newRow);

	// $(document).ready(function() {
	// 	$("#calendar-table").click(function(event) {
	// 		alert(event.target.id);
	// 	});
	// });
	//Begin citation: https://www.formget.com/jquery-dialog-form/
	$(document).ready(function() {
	$(function() {
			$("#calendar-table").on("click", function(event) {
				$.ajax({
					url: "checkeventcount.php",
					type: "POST",
					data: {date : event.target.id},
					success: function(data){
						if(data === 0)
						{
							addEvent(event.target.id);
						}
						else{
							listEvents(event.target.id);
						}
					}
				});
				
				
			});
		});
	});

	// End citation 

	var weeks = currentMonth.getWeeks();

	for(var w in weeks){
		var newRow = document.createElement("tr");
		newRow.setAttribute("class", "calendar");
		var days = weeks[w].getDates();
		// days contains normal JavaScript Date objects.
		for(var d in days){ 
			fullDate = days[d].toISOString().substring(0, 10); 
			var newCell = document.createElement("td");
			newCell.setAttribute("id", fullDate);
			newCell.setAttribute("class", "calendar");
			newCell.appendChild(document.createTextNode(String(days[d].getDate())));
			(function(fullDate)
			{$.ajax({
				url: "checkeventcount.php",
				type: "POST",
				data: {date : fullDate},
				success: function(data){
					generateDay(fullDate, data);
				}
			});
		})(fullDate);
			newRow.appendChild(newCell);
		}
		document.getElementById("calendar-table").appendChild(newRow);
	}
	document.getElementById("next_month_btn").addEventListener("click", nextMonth, false);
	document.getElementById("prev_month_btn").addEventListener("click", prevMonth, false);

}

function generateDay(fullDate, count){
	var newCell = document.getElementById(fullDate);
	if(count > 0)
	{	
		var numEvents = count + " Events";
		newCell.appendChild(document.createElement("br"));
		newCell.appendChild(document.createTextNode(numEvents));
	}
}

function getCount(fullDate){
	$.ajax({
		url: "checkeventcount.php",
		type: "POST",
		data: {date : fullDate},
		success: function(data){
			return data; 
		}
	});
	//$.post("checkeventcount.php", {date : fullDate}, function(){});
}

function listEvents(fullDate){
	document.getElementById("displayEvents").innerHTML = originalDisplay;
	$("#displayEvents").dialog({
		autoOpen: false
	});
	$.ajax({
		url: "calshowevents.php",
		type: "POST",
		dataType: "json",
		data: {date : fullDate},
		success: function(results){
			$.each(results, function(index, element) {
				var id = element.id; 
				var time = element.time;
				var title = element.title 
				var newEvent = document.createElement("tr");
				var newCell = document.createElement("td");
				newCell.setAttribute("id", id);
				newCell.appendChild(document.createTextNode(time + ": " + title));
				newEvent.appendChild(newCell);
				document.getElementById("displayEvents").appendChild(newEvent);
			});
			var newButton = document.createElement("BUTTON");
			newButton.setAttribute("id", "addAnotherEvent");
			newButton.setAttribute("value", "Add Event");
			document.getElementById("displayEvents").appendChild(newButton);
			$("#displayEvents").dialog("open");
			$("#addAnotherEvent").click(function() {
				$("#displayEvents").dialog("close");
				addEvent(fullDate);
			});
			$("#displayEvents").on("click", function(event){
				var eventID = event.target.id;
				$("#modifyEvent").dialog({
					autoOpen: false
				});
				$("#modifyEvent").dialog("open");
				$("#newEventSubmit").on("click", function(){
					alert(document.getElementById("newEventDate").value);
					editEvent(document.getElementById("newEventDate").value, document.getElementById("newEventTime").value, document.getElementById("newEventTitle").value, eventID);
				});
				$("#deleteEvent").on("click", function(){
					deleteEvent(eventID);
				});
			});
		}
	});
}

function editEvent(newDate, newTime, newTitle, eventID){
	$.ajax({
				url: "caleditevent.php",
				type: "POST",
				data: {new_date : newDate, new_time: newTime, new_title: newTitle, id: eventID},
				success: function(data){
					updateCalendar();
				}
		});
	// $.post("caleditevent.php", {new_date : newDate, new_time: newTime, new_title: newTitle, id: eventID}, function(status){
	// 	console.log(status);
	// });
	// updateCalendar();
}

function deleteEvent(eventID){
	$.ajax({
				url: "caldeleteevent.php",
				type: "POST",
				data: {id : eventID},
				success: function(data){
					updateCalendar();
				}
		});

	// $.post("caldeleteevent.php", {id : eventID}, function(status){
	// 	console.log(status);
	// });
	// updateCalendar();
}

function addEvent(fullDate){
	$("#container").dialog({
				autoOpen: false
			});
	$("#addStuff").dialog({
				autoOpen: false
			});
	$("#addStuff").dialog("open");
	// $( "#addStuff" ).bind('clickoutside',function(){
	// 	$( "#addStuff" ).dialog('close');
	// });
	$("#eventSubmit").click(function() {
		var time = $("#eventTime").val();
		var title = $("#eventTitle").val();
		console.log(title);
		$.ajax({
				url: "checkeventcount.php",
				type: "POST",
				data: {date : fullDate},
				success: function(data){
					generateDay(fullDate, data);
				}
		});
		$.post("calnewevent.php", {date: fullDate, time: time, event_title: title}, function(status){
			updateCalendar;
		});
	});
}

function prevMonth(){
	currentMonth = currentMonth.prevMonth();
	updateCalendar();
}

function nextMonth(){
	currentMonth = currentMonth.nextMonth();
	updateCalendar();
}


</script>
